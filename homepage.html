<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fitzwilliam Snooker Club – Home</title>
  <style>
    /* Basic reset & typography */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Open Sans', sans-serif;
      background: #f5f1e9;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
      position: relative;
    }
    header h1 {
      font-family: 'Merriweather', serif;
      font-size: 2rem;
      color: #004d19;
      margin-bottom: 2rem;
      text-align: center;
      word-break: break-word;
      line-height: 1.2;
    }

    /* Vertical button list */
    .btn-list {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 360px;
    }
    .btn-list button {
      background: #c29500;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      margin: 0.5rem 0;
      width: 100%;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s ease;
    }
    .btn-list button:hover {
      background: #a17a00;
    }

    /* overlay for modal */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 100;
    }

    /* Messages modal */
    .modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 6px;
      width: 90%;
      max-width: 400px;
      height: 80vh;
      display: none;
      flex-direction: column;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 200;
    }
    .modal .header {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
      color: #004d19;
      position: relative;
    }
    .modal .header .close {
      position: absolute;
      top: 1rem; right: 1rem;
      cursor: pointer;
      font-size: 1.2rem;
      color: #666;
    }
    .modal .messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
    }
    .modal .chat-input {
      padding: 0.5rem;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 0.5rem;
    }
    .modal .chat-input textarea {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
      font-family: inherit;
    }
    .modal .chat-input button {
      background: #004d19;
      color: white;
      border: none;
      padding: 0 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .modal .chat-input button:hover {
      background: #003712;
    }

    /* WhatsApp‐style message bubble */
    .msg-wrapper {
      margin: 0.5rem 0;
      display: flex;
      flex-direction: column;
    }
    .msg-date {
      font-size: 0.75rem;
      color: #666;
      text-align: center;
      margin-bottom: 0.25rem;
    }
    .msg-bubble {
      position: relative;
      padding: 0.5rem 0.75rem;
      background: #dcf8c6;
      border-radius: 8px;
      max-width: 80%;
      align-self: flex-start;
    }
    .msg-bubble .sender {
      font-weight: bold;
      color: #004d19;
      margin-bottom: 0.25rem;
    }
    .msg-bubble .text {
      margin-bottom: 0.5rem;
    }
    .msg-bubble .time {
      position: absolute;
      bottom: 0.25rem;
      right: 0.5rem;
      font-size: 0.75rem;
      color: #666;
    }
  </style>
</head>
<body>

  <header>
    <h1 id="welcome">Welcome</h1>
  </header>

  <div class="btn-list">
    <button id="tournamentsBtn">My tournaments</button>
    <button id="newsBtn">News</button>
    <button id="messagesBtn">Messages</button>
  </div>

  <div id="overlay"></div>

  <!-- Messages Modal -->
  <div id="messagesModal" class="modal">
    <div class="header">
      Messages
      <span class="close" data-target="messagesModal">&times;</span>
    </div>
    <div class="messages" id="msgsContainer"></div>
    <div class="chat-input">
      <textarea id="msgInput" rows="2" placeholder="Type a message…"></textarea>
      <button id="sendMsgBtn">Send</button>
    </div>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwvtwMIIJAGuZgFqz23R7J08pIEnNAyqn7c_Ks8VpAkybq795R04xNrF6SQVAvS6kbJ/exec';

    function jsonpRequest(params, cb) {
      const cbName = 'cb_' + Math.random().toString(36).slice(2);
      window[cbName] = data => {
        delete window[cbName];
        document.body.removeChild(script);
        cb(data);
      };
      params.callback = cbName;
      const qs = Object.entries(params)
        .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)
        .join('&');
      const script = document.createElement('script');
      script.src = `${WEB_APP_URL}?${qs}`;
      document.body.appendChild(script);
    }

    // show/hide overlay & modals
    function toggleModal(id, show) {
      document.getElementById('overlay').style.display = show ? 'block' : 'none';
      document.getElementById(id).style.display = show ? 'flex' : 'none';
    }

    // load playerName, redirect if missing
    const playerName = localStorage.getItem('playerName');
    if (!playerName) {
      window.location.href = 'index.html';
    } else {
      document.getElementById('welcome').textContent = `Welcome, ${playerName}`;
    }

    // main buttons
    document.getElementById('messagesBtn').onclick = () => {
      toggleModal('messagesModal', true);
      loadMessages();
      window.msgInterval = setInterval(loadMessages, 5000);
    };

    document.getElementById('overlay').onclick = () => {
      toggleModal('messagesModal', false);
      clearInterval(window.msgInterval);
    };
    document.querySelectorAll('.close').forEach(x => {
      x.onclick = () => {
        toggleModal(x.dataset.target, false);
        clearInterval(window.msgInterval);
      };
    });

    // fetch & render messages
    function loadMessages() {
      jsonpRequest({ action: 'getMessages' }, data => {
        const wrap = document.getElementById('msgsContainer');
        wrap.innerHTML = '';
        data.forEach(msg => {
          const d = new Date(msg.timestamp);
          const date = d.toLocaleDateString();
          const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const outer = document.createElement('div');
          outer.className = 'msg-wrapper';
          outer.innerHTML = `
            <div class="msg-date">${date}</div>
            <div class="msg-bubble">
              <div class="sender">${msg.name}</div>
              <div class="text">${msg.message}</div>
              <div class="time">${time}</div>
            </div>`;
          wrap.appendChild(outer);
        });
        wrap.scrollTop = wrap.scrollHeight;
      });
    }

    // send a message
    document.getElementById('sendMsgBtn').onclick = () => {
      const txt = document.getElementById('msgInput').value.trim();
      if (!txt) return;
      jsonpRequest({ action: 'sendMessage', name: playerName, message: txt }, resp => {
        if (resp.status === 'ok') {
          document.getElementById('msgInput').value = '';
          loadMessages();
        } else {
          alert('Send error: ' + resp.message);
        }
      });
    };
  </script>
</body>
</html>
